
<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<link rel="stylesheet" href="styles.css">
<script type="text/javascript">
window.onload = function () {
var conn;
var msg = document.getElementById("msg");
var log = document.getElementById("log");

function createTextLinks_(text) {

  return (text || "")
    .replace(
      /\{([^\{\}]+)\}/ig,
      function(match, curl){
        return "<"+curl+">"
      }
    )
    .replace(
      /\{\{([^\}]+)\}\}/ig,
      function(match, curl){
        return "{"+curl+"}"
      }
    )
    .replace(
      /([^\S]|^)((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/gi,
    function(match, space, url){
      var hyperlink = url;
      if (!hyperlink.match('^https?:\/\/')) {
        hyperlink = 'http://' + hyperlink;
      }
      if(hyperlink.match('https?:\/\/(www.)?youtu\.?be')){
        var match = /https?:\/\/(www.)?youtu(\.be|be\.com)\/(watch\?v=|embed\/)?([^&]+)(&[^&]+)*/g.exec(hyperlink);
        return space + '<iframe width="560" height="315" src="https://www.youtube.com/embed/'+match[4]+'" frameborder="0" allowfullscreen></iframe>';
      }
      else {
        return space + '<a href="' + hyperlink + '" target="_blank">' + url + '</a>';
      }
    });

};

function appendLog(item) {
    var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
    log.appendChild(item);
    if (doScroll) {
        log.scrollTop = log.scrollHeight - log.clientHeight;
    }
}
document.getElementById("form").onsubmit = function () {
    if (!conn) {
        return false;
    }
    if (!msg.value) {
        return false;
    }
    if (msg.value.charAt(0) == '/') {
      var index = msg.value.indexOf(' ');
      if (index != -1) {
        conn.send("{"+msg.value.substring(0,index)+"}"+msg.value.substring(index+1));
      }
      else {
        conn.send("{"+msg.value+"}");
      }

    }
    else {
      conn.send("{chat_msg}"+msg.value);
    }
    msg.value = "";
    return false;
};
if (window["WebSocket"]) {
    conn = new WebSocket("ws://" + document.location.host + "/ws");
    conn.onopen = function (evt) {
      conn.send("{new_connection}");
    };
    conn.onclose = function (evt) {
        var item = document.createElement("div");
        item.innerHTML = "<b>Connection closed.</b>";
        appendLog(item);
    };
    conn.onmessage = function (evt) {
        var result = /\{([^\{\}]+)\}(.*)/g.exec(evt.data);
        switch (result[1]){
          case "chat_msg":{
          var messages = result[2].split('\n');
          for (var i = 0; i < messages.length; i++) {
            var item = document.createElement("div");
            item.innerHTML = createTextLinks_(messages[i]);
            appendLog(item);
          }
          break;
        }
        case "admin_msg":{
          var messages = result[2].split('\n');
          for (var i = 0; i < messages.length; i++) {
            var item = document.createElement("div");
            item.innerHTML = createTextLinks_(messages[i]);
            appendLog(item);
          }
          break;
        }
        case "new_connection": {
          var item = document.createElement("div");
          item.innerHTML = createTextLinks_(result[2]);
          appendLog(item);
          break;
        }
        }
    };
} else {
    var item = document.createElement("div");
    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
    appendLog(item);
}

document.getElementById("popup").style.display = "block";
};
function pass_done() {
    document.getElementById("popup").style.display = "none";
    var password = document.getElementById("pass").value;

    //DO STUFF WITH PASSWORD HERE
};
</script>
</head>
<body>
<div id="popup">
  <div>Enter Username:</div>
  <input id="username" type="text"/>
  <div>Enter Password:</div>
  <input id="pass" type="password"/>
  <button onclick="pass_done()">Done</button>
</div>
<div id="log"></div>
<form id="form">
<input type="submit" value="Send" />
<input type="text" id="msg" size="64"/>
</form>
</body>
</html>
