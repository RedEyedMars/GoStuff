
<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<link rel="stylesheet" type="text/css" href="styles.css">
<script type="text/javascript">
function checkUsername_(username){
  if(/^[a-z0-9_-]{3,32}$/igm.test(username)){
    document.getElementById("username_status").src = "Success.jpg"
    document.getElementById("username_status").alt = ""
  } else {
    if(username.lenth()<3){
      document.getElementById("username_status").src = "Pending.jpg"
      document.getElementById("username_status").alt = "Usernames must be greater than 3 characters long!"
    } else if(username.lenth()>=32){
      document.getElementById("username_status").src = "Fail.jpg"
      document.getElementById("username_status").alt = "Usernames must be less than 33 characters long!"
    } else if(/^.*\s.*$/igm.test(username)){
      document.getElementById("username_status").src = "Fail.jpg"
      document.getElementById("username_status").alt = "Usernames must have no spaces in them!"
    } else if(/^.*[!@#$%^&*+=\(\)\[\]\{\}:;,\.\'\`~<>\/\\].*$/igm.test(username)){
      document.getElementById("username_status").src = "Fail.jpg"
      document.getElementById("username_status").alt = "Usernames must have no special characters in them!"
    } else {
      document.getElementById("username_status").src = "Fail.jpg"
      document.getElementById("username_status").alt = "Your username is not valid!"
    }
  }
};

function createTextLinks_(text) {
  return (text || "")
    .replace(/\{([^\{\}]+)\}/ig,  function(match, curl){ return "<"+curl+">"})
    .replace(/\{\{([^\}]+)\}\}/ig,function(match, curl){ return "{"+curl+"}"})
    .replace(/([^\S]|^)((([A-Za-z]{3,9}:(?:\/\/)?)(?:[-;:&=\+\$,\w]+@)?[A-Za-z0-9.-]+|(?:www.|[-;:&=\+\$,\w]+@)[A-Za-z0-9.-]+)((?:\/[\+~%\/.\w-_]*)?\??(?:[-\+=&;%@.\w_]*)#?(?:[\w]*))?)/gi,
    function(match, space, url){
      var hyperlink = url;
      if (!hyperlink.match('^https?:\/\/')) {
        hyperlink = 'http://' + hyperlink;
      }
      if(hyperlink.match('https?:\/\/(www.)?youtu\.?be')){
        var match = /https?:\/\/(www.)?youtu(\.be|be\.com)\/(watch\?v=|embed\/)?([^&]+)(&[^&]+)*/g.exec(hyperlink);
        return space + '<iframe width="560" height="315" src="https://www.youtube.com/embed/'+match[4]+'" frameborder="0" allowfullscreen></iframe>';
      }
      else {
        return space + '<a href="' + hyperlink + '" target="_blank">' + url + '</a>';
      }
    });
};

window.onload = function () {
  var conn;
  var msg = document.getElementById("msg");
  var log = document.getElementById("log");

  function appendLog(item) {
    var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
    log.appendChild(item);
    if (doScroll) {
        log.scrollTop = log.scrollHeight - log.clientHeight;
    }
  }
  document.getElementById("chat").onsubmit = function () {
    if (!conn) {
        return false;
    }
    if (!msg.value) {
        return false;
    }
    if (msg.value.charAt(0) == '/') {
      var index = msg.value.indexOf(' ');
      if (index != -1) {
        conn.send("{"+msg.value.substring(0,index)+"}"+msg.value.substring(index+1));
      }
      else {
        conn.send("{"+msg.value+"}");
      }

    }
    else {
      conn.send("{chat_msg}"+msg.value);
    }
    msg.value = "";
    return false;
};
if (window["WebSocket"]) {
    conn = new WebSocket("ws://" + document.location.host + "/ws");
    conn.onopen = function (evt) {
      conn.send("{new_connection}");
    };
    conn.onclose = function (evt) {
        var item = document.createElement("div");
        item.innerHTML = "<b>Connection closed.</b>";
        appendLog(item);
    };
    conn.onmessage = function (evt) {
        var result = /\{([^\{\}]+)\}(.*)/g.exec(evt.data);
        switch (result[1]){
          case "chat_msg":{
          var messages = result[2].split('\n');
          for (var i = 0; i < messages.length; i++) {
            var item = document.createElement("div");
            item.innerHTML = createTextLinks_(messages[i]);
            appendLog(item);
          }
          break;
        }
        case "admin_msg":{
          var messages = result[2].split('\n');
          for (var i = 0; i < messages.length; i++) {
            var item = document.createElement("div");
            item.innerHTML = createTextLinks_(messages[i]);
            appendLog(item);
          }
          break;
        }
        case "new_connection": {
          var item = document.createElement("div");
          item.innerHTML = createTextLinks_(result[2]);
          appendLog(item);
          break;
        }
        }
    };
  } else {
    var item = document.createElement("div");
    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
    appendLog(item);
  }
};
function pass_done() {
    document.getElementById("popup").style.display = "none";
    document.getElementById("chat_div").style.display = "block";
    var password = document.getElementById("pass").value;

    //DO STUFF WITH PASSWORD HERE
};
</script>
</head>
<body>
<div id="popup">
    <div>Enter Username:</div>
    <input id="username" onchange="checkUsername_();" type="text"/>
    <img id="username_status" src="Pending.jpg" alt="Please enter a username"></img>
    <div>Enter Password:</div>
    <input id="pass" type="password"/>
    <button onclick="pass_done()">Done</button>
</div>
<div id="chat_div">
  <div id="log"></div>
  <form id="chat">
    <input type="submit" value="Send" />
    <input type="text" id="msg" size="64"/>
  </form>
</div>
</body>
</html>
